apiVersion: ops.crossplane.io/v1alpha1
kind: CronOperation
metadata:
  name: rds-intelligent-scaling-cron
  labels:
    provider: aws
    type: intelligent-scaling-cron
    feature: cost-effective-scheduled-scaling
spec:
  concurrencyPolicy: Forbid
  successfulHistoryLimit: 5
  failedHistoryLimit: 1

  operationTemplate:
    spec:
      mode: Pipeline
      pipeline:
      - step: upbound-function-claude
        functionRef:
          name: upbound-function-claude
        requirements:
          requiredResources:
          - apiVersion: aws.platform.upbound.io/v1alpha1
            kind: SQLInstance
            namespace: database-team
            matchLabels:
              scale: me
            requirementName: ops.crossplane.io/watched-resource
        input:
          apiVersion: claude.fn.upbound.io/v1alpha1
          kind: Prompt
          modelName: claude-haiku-4-5 # haiku brings serious cost savings
          systemPrompt: |
            You are an intelligent RDS scaling system that analyzes SQLInstance resources
            and makes scaling decisions based on CloudWatch performance metrics.

            Return a JSON patch for the SQLInstance resource.
          userPrompt: |
            You are analyzing a SQLInstance resource for potential RDS scaling needs.

            SCALING ANALYSIS CRITERIA:
            1. Check performance metrics in status.performanceMetrics
            2. Check current instanceClass in spec.parameters.instanceClass
            3. Check if analysis was done recently (intelligent-scaling annotations)

            RATE LIMITING:
            - Skip analysis if "intelligent-scaling/last-analyzed" annotation exists and is < 1 minute old
            - Only proceed if no recent analysis or if metrics show significant changes

            SCALING TRIGGERS (demo-optimized for visibility):
            - SCALE UP: CPU > 60%, Memory < 15%, Connections > 85%
            - SCALE DOWN: CPU < 20% AND Memory > 60% AND Connections < 30% for sustained period

            INSTANCE CLASS PROGRESSION (bidirectional):
            db.t3.micro ↔ db.t3.small ↔ db.t3.medium ↔ db.t3.large

            DOWNSCALING SAFETY:
            - Only scale down if ALL conditions met for sustained period
            - Check last-scaled annotation to prevent frequent changes
            - Ensure minimum 5-minute cooldown between scaling events

            OUTPUT FORMAT:
            Return a JSON patch containing only the fields that need updating.

            If scaling is needed:
            {
              "apiVersion": "aws.platform.upbound.io/v1alpha1",
              "kind": "SQLInstance",
              "metadata": {
                "name": "<exact-resource-name>",
                "namespace": "<exact-namespace>",
                "annotations": {
                  "intelligent-scaling/last-scaled": "<current-timestamp-iso8601>",
                  "intelligent-scaling/last-scaled-decision": "<reasoning-for-scaling>"
                }
              },
              "spec": {
                "parameters": {
                  "instanceClass": "<new-instance-class>"
                }
              }
            }

            If no scaling is needed:
            {
              "apiVersion": "aws.platform.upbound.io/v1alpha1",
              "kind": "SQLInstance",
              "metadata": {
                "name": "<exact-resource-name>",
                "namespace": "<exact-namespace>",
                "annotations": {
                  "intelligent-scaling/last-analyzed": "<current-timestamp-iso8601>",
                  "intelligent-scaling/last-scaled-decision": "<reasoning-for-no-scaling>"
                }
              }
            }

            Rules:
            - Use exact resource name and namespace from input
            - Use current timestamp in ISO8601 format (YYYY-MM-DDTHH:MM:SSZ)
            - Provide clear, concise reasoning in decision annotation
            - Include namespace in metadata (v2 resources are namespaced)

            SQLInstance Resource:
            {{ .Resources }}
        credentials:
        - name: claude
          source: Secret
          secretRef:
            namespace: crossplane-system
            name: claude
      retryLimit: 3
  schedule: '* * * * *'  # Run every minute for demo
